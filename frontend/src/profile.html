<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mute - Профиль пользователя</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100..900;1,100..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <style>
        .profile-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 40px;
            background: linear-gradient(145deg, #1a1a1a, #212121);
            border-radius: 16px;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .profile-container::before {
            content: '';
            position: absolute;
            top: -80px;
            right: -80px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(94, 23, 235, 0.15), transparent 70%);
            z-index: 0;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin-right: 25px;
            object-fit: cover;
            background-color: #2a2a2a;
            border: 4px solid rgba(94, 23, 235, 0.3);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin: 40px 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-item {
            flex: 1;
            padding: 10px;
            position: relative;
        }
        
        .stat-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 25%;
            height: 50%;
            width: 1px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #5e17eb, #9b7be0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .profile-tabs {
            margin-top: 40px;
            position: relative;
            z-index: 1;
        }
        
        .nav-tabs {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border: none;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            padding: 12px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            color: #9b7be0;
            border-color: transparent;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-tabs .nav-link.active {
            color: #fff;
            background: transparent;
            border-bottom: 2px solid #5e17eb;
        }
        
        .tab-pane {
            padding: 30px 0;
        }
        
        .card {
            background: linear-gradient(145deg, #1a1a1a, #212121);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }
        
        .card-img-top {
            height: 160px;
            object-fit: cover;
        }
        
        .btn-play {
            background: linear-gradient(145deg, #5e17eb, #8a63d2);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-play:hover {
            background: linear-gradient(145deg, #6d30f5, #9b7be0);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        .btn-remove {
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .btn-remove:hover {
            color: #ff3366;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn-logout {
            background: linear-gradient(145deg, #e63946, #ff4d6d);
            border: none;
            border-radius: 30px;
            padding: 12px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-logout:hover {
            background: linear-gradient(145deg, #ff4d6d, #e63946);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .alert {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }
        
        .alert-link {
            color: #9b7be0;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .alert-link:hover {
            color: #6d30f5;
            text-decoration: underline;
        }
        
        .custom-player {
            background: linear-gradient(90deg, #1a1a1a, #262626);
            border-radius: 12px;
            padding: 15px 20px;
            margin: 30px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .player-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-right: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .player-text {
            flex: 1;
        }
        
        .player-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: white;
        }
        
        .player-artist {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .ctrl-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .ctrl-btn:hover {
            color: #5e17eb;
            transform: scale(1.1);
        }
        
        .play-pause-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(145deg, #5e17eb, #8a63d2);
            color: white;
            font-size: 18px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .play-pause-btn:hover {
            background: linear-gradient(145deg, #6d30f5, #9b7be0);
            transform: scale(1.05);
        }
        
        #audio-player {
            display: none;
        }
        
        .header-links a {
            text-decoration: none;
            margin-right: 20px;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .header-links a:hover {
            color: #5e17eb !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-wrapper d-flex justify-content-between align-items-center">
            <div class="logo">
                <a href="index.html"><img src="../static/images/mute-512.webp" alt="Логотип" style="height: 50px;"></a>
            </div>
            <div class="header-links d-flex align-items-center">
                <a href="index.html" class="text-white me-3"><i class="fas fa-home me-2"></i>Главная</a>
                <a href="favorites.html" class="text-white me-3"><i class="fas fa-heart me-2"></i>Избранное</a>
                <div class="auth-section">
                    <!-- Здесь будет отображаться информация о пользователе или кнопки входа -->
                </div>
            </div>
        </div>
    </header>

    <div class="container" id="main-container" style="margin-top: 80px;">
        <div class="profile-container" id="profile-content">
            <!-- Содержимое профиля будет загружено динамически -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <script src="js/auth.js"></script>
    <script src="js/favorites.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, авторизован ли пользователь
            if (!isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Получаем данные пользователя
            const userData = getUserData();
            loadUserProfile(userData);
        });
        
        async function loadUserProfile(userData) {
            try {
                let userApiData = {};
                if (userData.id) {
                    try {
                        const accessToken = localStorage.getItem('jwt-access-token');
                        console.log('accessToken', accessToken);
                        const response = await fetch('http://localhost/user/get', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                        if (response.ok) {
                            userApiData = await response.json();
                            console.log('User API data from server:', userApiData);
                            console.log('User ID from server:', userApiData.id);
                        } else {
                            console.error('Error fetching user data:', response.status, await response.text());
                        }
                    } catch (error) {
                        console.error('Ошибка получения данных о пользователе:', error);
                    }
                }

                // Загрузим избранные треки
                const favoriteTracks = await loadFavoriteTracks() || [];
                
                const profileContent = document.getElementById('profile-content');
                profileContent.innerHTML = `
                    <div class="profile-header">
                        <img src="../static/images/247319.png" alt="Profile" class="profile-avatar">
                        <div>
                            <h2 style="font-weight: 700; letter-spacing: -0.5px;">${userData.username}</h2>
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.95rem;"><i class="fas fa-calendar-alt me-2"></i>Участник с ${new Date(userData.loginTime).toLocaleDateString()}</p>
                        </div>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-number">${favoriteTracks.length}</span>
                            <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">Избранных треков</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">0</span>
                            <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">Плейлистов</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">0</span>
                            <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">Подписчиков</span>
                        </div>
                    </div>
                    
                    <div class="custom-player" id="custom-player" style="display: none;">
                        <div class="player-info">
                            <img src="" alt="Cover" class="player-cover" id="player-cover">
                            <div class="player-text">
                                <div class="player-title" id="player-title">Не выбрано</div>
                                <div class="player-artist" id="player-artist">Выберите трек для воспроизведения</div>
                            </div>
                        </div>
                        <div class="player-controls">
                            <button class="ctrl-btn" id="prev-btn"><i class="fas fa-step-backward"></i></button>
                            <button class="play-pause-btn" id="play-pause-btn"><i class="fas fa-play" id="play-icon"></i></button>
                            <button class="ctrl-btn" id="next-btn"><i class="fas fa-step-forward"></i></button>
                        </div>
                    </div>
                    
                    <div class="profile-tabs">
                        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tracks-tab" data-bs-toggle="tab" data-bs-target="#tracks" type="button" role="tab">
                                    <i class="fas fa-music me-2"></i>Избранные треки
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="playlists-tab" data-bs-toggle="tab" data-bs-target="#playlists" type="button" role="tab">
                                    <i class="fas fa-list me-2"></i>Плейлисты
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                                    <i class="fas fa-cog me-2"></i>Настройки
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="profileTabsContent">
                            <div class="tab-pane fade show active" id="tracks" role="tabpanel">
                                <div id="favorite-tracks" class="mt-4">
                                    ${renderFavoriteTracks(favoriteTracks)}
                                </div>
                            </div>
                            <div class="tab-pane fade" id="playlists" role="tabpanel">
                                <div class="alert mt-4">
                                    <i class="fas fa-info-circle me-2"></i> Вы еще не создали плейлисты.
                                </div>
                            </div>
                            <div class="tab-pane fade" id="settings" role="tabpanel">
                                <div class="mt-4">
                                    <h4 style="font-weight: 600;"><i class="fas fa-user-cog me-2"></i>Настройки профиля</h4>
                                    <form id="profileSettingsForm" class="mt-4">
                                        <div class="mb-3">
                                            <label for="username" class="form-label">Имя пользователя</label>
                                            <div class="input-group">
                                                <span class="input-group-text" style="background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-right: none;">
                                                    <i class="fas fa-user" style="color: rgba(255, 255, 255, 0.6);"></i>
                                                </span>
                                                <input type="text" class="form-control" style="border-left: none;" id="username" value="${userData.username}" disabled>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <div class="input-group">
                                                <span class="input-group-text" style="background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-right: none;">
                                                    <i class="fas fa-envelope" style="color: rgba(255, 255, 255, 0.6);"></i>
                                                </span>
                                                <input type="email" class="form-control" style="border-left: none;" id="email" placeholder="Ваш email" value="${userApiData.email || ''}">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="user-id" class="form-label">ID пользователя</label>
                                            <div class="input-group">
                                                <span class="input-group-text" style="background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-right: none;">
                                                    <i class="fas fa-id-card" style="color: rgba(255, 255, 255, 0.6);"></i>
                                                </span>
                                                <input type="text" class="form-control" style="border-left: none;" id="user-id" value="${userApiData.id || userData.id || 'Не определен'}" disabled>
                                            </div>
                                        </div>
                                        <div class="mb-3 mt-4">
                                            <button type="button" class="btn btn-danger btn-logout" onclick="logout()">
                                                <i class="fas fa-sign-out-alt me-2"></i>Выйти из аккаунта
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Добавляем и настраиваем аудиоплеер
                const audioPlayer = document.createElement('audio');
                audioPlayer.id = 'audio-player';
                audioPlayer.className = 'music-player';
                audioPlayer.controls = true;
                profileContent.appendChild(audioPlayer);
                
                // Настраиваем управление плеером
                setupPlayerControls();
                
                // Устанавливаем массив треков для навигации
                window.currentTrackIndex = -1;
                window.favoriteTracks = favoriteTracks;
                
            } catch (error) {
                console.error('Ошибка при загрузке профиля:', error);
            }
        }
        
        function setupPlayerControls() {
            const audioPlayer = document.getElementById('audio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            
            if (!audioPlayer || !playPauseBtn || !playIcon) return;
            
            playPauseBtn.addEventListener('click', function() {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    playIcon.className = 'fas fa-pause';
                } else {
                    audioPlayer.pause();
                    playIcon.className = 'fas fa-play';
                }
            });
            
            audioPlayer.addEventListener('play', function() {
                playIcon.className = 'fas fa-pause';
            });
            
            audioPlayer.addEventListener('pause', function() {
                playIcon.className = 'fas fa-play';
            });
            
            audioPlayer.addEventListener('ended', function() {
                playIcon.className = 'fas fa-play';
            });
            
            // Настройка кнопок навигации
            document.getElementById('prev-btn')?.addEventListener('click', playPreviousTrack);
            document.getElementById('next-btn')?.addEventListener('click', playNextTrack);
        }
        
        // Функция для рендеринга списка избранных треков
        function renderFavoriteTracks(tracks) {
            if (!tracks || tracks.length === 0) {
                return `
                    <div class="alert">
                        <i class="fas fa-heart-broken me-2"></i> У вас пока нет избранных треков. 
                        <a href="index.html" class="alert-link">Перейдите на главную страницу</a>, чтобы добавить треки в избранное.
                    </div>
                `;
            }
            
            let html = '<div class="row g-4">';
            
            tracks.forEach((track, index) => {
                html += `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100" onclick="playTrack(${index})">
                            <img src="${track.coverUrl}" class="card-img-top" alt="${track.title}">
                            <div class="card-body">
                                <h5 class="card-title" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${track.title}</h5>
                                <p class="card-text" style="color: rgba(255, 255, 255, 0.7); margin-bottom: 15px; font-size: 0.9rem;">${track.artist || track.artist_id}</p>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-play" onclick="event.stopPropagation(); playTrack(${index})">
                                        <i class="fas fa-play me-1"></i> Слушать
                                    </button>
                                    <button class="btn btn-remove" onclick="event.stopPropagation(); removeTrackFromFavorites('${track.id}')">
                                        <i class="fas fa-heart-broken me-1"></i> Удалить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // Функция для воспроизведения трека
        function playTrack(index) {
            if (!window.favoriteTracks || index < 0 || index >= window.favoriteTracks.length) return;
            
            const track = window.favoriteTracks[index];
            window.currentTrackIndex = index;
            
            console.log(`Playing track: ${track.streamUrl}`);
            
            try {
                const audioPlayer = document.getElementById('audio-player');
                const customPlayer = document.getElementById('custom-player');
                const playerCover = document.getElementById('player-cover');
                const playerTitle = document.getElementById('player-title');
                const playerArtist = document.getElementById('player-artist');
                
                // Показываем плеер
                customPlayer.style.display = 'flex';
                
                // Обновляем информацию в плеере
                playerCover.src = track.coverUrl;
                playerTitle.textContent = track.title;
                playerArtist.textContent = track.artist || track.artist_id;
                
                // Воспроизводим трек
                audioPlayer.src = track.streamUrl;
                audioPlayer.load();
                audioPlayer.play();
            } catch (error) {
                console.error('Failed to play track:', error);
                alert('Failed to play track. Check console for details');
            }
        }
        
        function playPreviousTrack() {
            if (window.currentTrackIndex > 0) {
                playTrack(window.currentTrackIndex - 1);
            }
        }
        
        function playNextTrack() {
            if (window.currentTrackIndex < window.favoriteTracks.length - 1) {
                playTrack(window.currentTrackIndex + 1);
            }
        }
        
        // Функция для удаления трека из избранного
        async function removeTrackFromFavorites(trackId) {
            const success = await removeFromFavorites(trackId);
            if (success) {
                // Обновляем UI после удаления
                const userData = getUserData();
                loadUserProfile(userData);
            }
        }
    </script>
</body>
</html> 